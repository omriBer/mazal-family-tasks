<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>מז"ל – משימות למשפחה</title>

  <!-- CSS ראשי -->
  <link rel="stylesheet" href="style.css" />

  <!-- מאפשר להתקין כמו אפליקציה במסך הבית -->
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;מז״ל&quot;,&quot;short_name&quot;:&quot;מז״ל&quot;,&quot;display&quot;:&quot;standalone&quot;}" />
  <meta name="theme-color" content="#ffe775" />
</head>
<body>

  <div class="app-frame">
    <div id="viewToggleRoot"></div>

    <div id="syncStatusContainer" class="sync-status-container"></div>

    <div id="parentMount"></div>
    <div id="kidMount"></div>

    <div class="footer-note">
      מז״ל – משימות, זמן ולב ❤<br />
      גרסה משפחתית בענן
    </div>
  </div>

  <div id="floatingNoticeRoot"></div>

  <!-- תבנית מתג בין מצב הורה / ילד -->
  <template id="viewToggleTemplate">
    <div class="view-toggle">
      <button class="toggle-btn" id="parentTab" onclick="openParentView()">הורה 👨‍👧</button>
      <button class="toggle-btn" id="kidTab" onclick="showCard('kid')">ילד 👧</button>
    </div>
  </template>

  <!-- תבנית כרטיס הורה -->
  <template id="parentViewTemplate">
    <section class="card" id="parentCard" aria-labelledby="parentCardTitle">
      <!-- מצב נעול (לפני סיסמה) -->
      <div id="parentLocked" class="locked-card">
        <div style="font-size:20px;font-weight:600;color:var(--text-dark);margin-bottom:8px;">
          🔒 אזור הורה נעול
        </div>
        <div>הכנס קוד בן 4 ספרות</div>

        <input id="parentPassInput" type="password" maxlength="4" placeholder="••••" />
        <button onclick="tryUnlockParent()">כניסה</button>

        <div class="lock-warn" id="lockWarn"></div>
      </div>

      <!-- מצב פתוח (אחרי סיסמה) -->
      <div id="parentContent" style="display:none;">

        <header class="brand-header">
          <div class="star-icon" aria-hidden="true"></div>
          <div class="brand-text">
            <div class="title" id="parentCardTitle">מז״ל</div>
            <div class="subtitle">
              שלום הורה 👋<br />
              הנה המשימות של הילדים להיום
            </div>
          </div>
        </header>

        <div class="progress-wrap">
          <div class="progress-circle" id="overallProgress">0%</div>
          <div class="progress-desc" id="overallText">
            <b>התקדמות כללית להיום</b><br />
            (נטען מהמערכת...)
          </div>
        </div>

        <button class="main-btn" id="openAddTask" onclick="openAddTaskModal()">
          ➕ הוספת משימה חדשה
        </button>

        <button class="sub-btn" id="openManageKids" onclick="openManageKidsModal()">
          ניהול ילדים 👨‍👧➕
        </button>

        <div id="parentKidsArea"></div>
      </div>
    </section>
  </template>

  <!-- תבנית כרטיס ילד -->
  <template id="kidViewTemplate">
  <!-- Watermark קסום -->
  <div class="watermark" aria-hidden="true"></div>

  <section class="card kid-card" id="kidCard" aria-labelledby="kidHeaderName">
    <!-- כרטיס עליון בסגנון Wireframe v3 -->
    <section class="top-card" aria-label="ראש הדף – שם, דרגה, כוכבים והתקדמות">
      <div class="top-left">
        <div class="kid-avatar-wrap">
          <img
            class="kid-avatar"
            id="kidAvatarImg"
            src="avatars/avatar-01.png"
            alt="אווטאר"
            role="button"
            tabindex="0"
            aria-label="בחרו דמות"
          />
          <!-- כפתור גלריית אווטארים -->
          <button class="avatar-badge" id="kidAvatarGalleryBtn" title="גלריית אווטארים" type="button">🖼️</button>
        </div>
      </div>

      <div class="top-center">
        <div class="kid-line">
          <h2 class="kid-name" id="kidHeaderName">היי 🧒</h2>
        </div>

        <!-- שורת דרגה וכוכבים -->
        <div class="rank-line" aria-label="תואר דרגה וכמות כוכבים">
          <div class="rank-title" id="kidLevelTitle">תואר דרגה</div>
          <div class="star-pill" id="kidStarsSummary">⭐ 0</div>
        </div>

        <!-- התקדמות לשלב הבא -->
        <div class="progress-wrap" aria-label="התקדמות לשלב הבא">
          <div class="progress-bar level-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="5" aria-valuenow="0" aria-label="התקדמות כוכבים בשלב">
            <div class="progress-fill level-progress-fill" id="kidLevelProgressFill" style="width:0%"></div>
          </div>
          <div class="to-next" id="kidLevelProgressText">0 מתוך 5 ⭐ בדרגה</div>
        </div>

        <!-- שלוש תחנות: נוכחית · הבאה · שאחריה -->
        <div class="stations" id="kidRankLine" aria-label="תואר נוכחי ושני התארים הבאים">
          <!-- מתמלא דינמית ב‑app.js -->
        </div>
      </div>

      <div class="top-right">
        <span class="top-tag">🎯 יום פעילות</span>
      </div>
    </section>

    <!-- טקסטים קצרים (אם יש) -->
    <div class="kid-top-line" id="kidHeadline"></div>
    <div class="kid-sub-line" id="kidSubline"></div>

    <!-- משימות היום -->
    <div id="kidTasksArea"></div>

    <!-- preview הודעות – נסתיר ב‑CSS -->
    <div id="kidMessagesArea" class="kid-messages-wrapper"></div>

    <!-- אזור שליחת הודעה קצר – נסתיר ב‑CSS -->
    <div class="send-feedback-area">
      <label for="kidNote">רוצה לשלוח הודעה להורה?</label>
      <textarea id="kidNote" placeholder="היה לי קשה עם הקיפול 👕"></textarea>
      <button class="send-btn" onclick="sendKidMessage()">שליחה להורה ➜</button>
    </div>
  </section>

  <!-- FAB הודעות (פותח את המודאל הקיים) -->
  <button class="fab" id="kidMessagesFab" type="button" aria-label="הודעות" title="הודעות">
    💬 <span>הודעה להורה</span>
    <span class="fab-badge" id="kidMessagesBadge"></span>
  </button>
</template>

  <template id="messagesModalTemplate">
    <div class="modal-bg" id="messagesModalBg" role="dialog" aria-modal="true" aria-labelledby="messagesModalTitle">
      <div class="modal-card messages-modal">
        <header class="modal-header">
          <h2 id="messagesModalTitle">הודעות 💬</h2>
          <button class="modal-close" id="messagesModalClose" aria-label="סגור">✕</button>
        </header>
        <div class="messages-thread" id="messagesModalThread"></div>
        <div class="messages-compose">
          <textarea id="messagesComposeText" placeholder="כתוב/כתבי הודעה..."></textarea>
          <button id="messagesComposeSend">שליחה ➤</button>
        </div>
      </div>
    </div>
  </template>

  <!-- תבנית מסך ילד לא נמצא -->
  <template id="kidMissingTemplate">
    <section class="card kid-missing-card" id="kidMissingCard">
      <div class="missing-message">
        <div class="missing-emoji" aria-hidden="true">💭</div>
        <h2>לא מצאנו ילד עם הקישור הזה</h2>
        <p>
          בקשו מההורה את הקישור הנכון 😌<br />
          ותיכנסו שוב לעולם הפרטי שלכם.
        </p>
      </div>
    </section>
  </template>

  <!-- תבנית מודאלים לאזור ההורה -->
  <template id="parentModalsTemplate">
    <div class="modal-backdrop" id="taskModalBg">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <button class="close-modal-btn" onclick="closeModal('taskModalBg')" aria-label="סגור">✕</button>

        <h2 id="modalTitle">משימה חדשה</h2>

        <label for="taskChild">למי המשימה?</label>
        <select id="taskChild"></select>

        <div class="task-scope-field">
          <div class="modal-field-label">למי המשימה תרד?</div>
          <label class="task-choice-option">
            <input
              type="radio"
              name="taskScope"
              id="taskScopeSingle"
              value="single"
              checked
            />
            <span class="task-choice-visual">
              <span class="task-choice-title" id="taskScopeSingleText">רק לילד הזה</span>
              <span class="task-choice-icon" id="taskScopeSingleIcon" aria-hidden="true">🙂</span>
            </span>
          </label>
          <label class="task-choice-option">
            <input
              type="radio"
              name="taskScope"
              id="taskScopeAll"
              value="all"
            />
            <span class="task-choice-visual">
              <span class="task-choice-title">לכל הילדים</span>
              <span class="task-choice-icon" aria-hidden="true">👨‍👧‍👦</span>
            </span>
          </label>
        </div>

        <label for="taskTitle">שם המשימה</label>
        <input id="taskTitle" placeholder="לסדר את החדר 🧹" />

        <label for="taskMeta">תיאור / יעד</label>
        <textarea
          id="taskMeta"
          placeholder="לפני ארוחת ערב, לבד בלי עזרה"
        ></textarea>

        <div class="task-schedule-field">
          <div class="modal-field-label">מתי המשימה תעלה?</div>
          <label class="task-choice-option">
            <input
              type="radio"
              name="taskSchedule"
              id="taskScheduleNow"
              value="now"
              checked
            />
            <span class="task-choice-visual">
              <span class="task-choice-title">מיידי</span>
              <span class="task-choice-icon" aria-hidden="true">✨</span>
            </span>
          </label>
          <label class="task-choice-option">
            <input
              type="radio"
              name="taskSchedule"
              id="taskScheduleTomorrow"
              value="tomorrow"
            />
            <span class="task-choice-visual">
              <span class="task-choice-title">מחר</span>
              <span class="task-choice-icon" aria-hidden="true">🌤️</span>
            </span>
          </label>
          <label class="task-choice-option">
            <input
              type="radio"
              name="taskSchedule"
              id="taskScheduleDayAfter"
              value="dayAfterTomorrow"
            />
            <span class="task-choice-visual">
              <span class="task-choice-title">מחרתיים</span>
              <span class="task-choice-icon" aria-hidden="true">🌈</span>
            </span>
          </label>
          <div class="task-schedule-hint">אם תבחר מחר – הילד יראה את זה רק מחר בבוקר 🌅</div>
        </div>

        <button class="save-task-btn" onclick="saveNewTask()">שמור</button>
      </div>
    </div>

    <div class="modal-backdrop" id="replyModalBg">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="replyTitle">
        <button class="close-modal-btn" onclick="closeModal('replyModalBg')" aria-label="סגור">✕</button>

        <h2 id="replyTitle">תגובה למשימה</h2>

        <div
          id="replyTaskName"
          style="font-size:14px;color:var(--text-mid);margin-bottom:8px;"
        ></div>

        <label for="replyText">הודעת הורה</label>
        <textarea
          id="replyText"
          placeholder="כל הכבוד על המאמץ 💖"
        ></textarea>

        <button class="save-reply-btn" onclick="saveReply()">שמור תגובה</button>
      </div>
    </div>

    <div class="modal-backdrop" id="manageKidsBg">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="manageKidsTitle">
        <button class="close-modal-btn" onclick="closeModal('manageKidsBg')" aria-label="סגור">✕</button>

        <h2 id="manageKidsTitle">ניהול ילדים</h2>

        <div id="kidsList"></div>

        <label for="newKidName">שם ילד חדש</label>
        <input id="newKidName" placeholder="למשל: גיל" />

        <label for="newKidIcon">אייקון/לב לילד</label>
        <input id="newKidIcon" placeholder="💛" />

        <label for="newKidColor">צבע CSS (אפשר 'Pink' / '#a8e1ff')</label>
        <input id="newKidColor" placeholder="var(--yellow)" />

        <button class="manage-kids-btn" onclick="addKid()">הוסף ילד</button>
      </div>
    </div>
  </template>

  <template id="celebrationStarTemplate">
    <div class="celebration-popup celebration-star" role="alert">
      <div class="icon" aria-hidden="true">⭐</div>
      <div class="title">⭐ קיבלת כוכב!</div>
      <div class="subtitle"></div>
    </div>
  </template>

  <template id="celebrationLevelTemplate">
    <div class="celebration-popup celebration-level" role="alert">
      <div class="icon" aria-hidden="true">🎉</div>
      <div class="title"></div>
      <div class="subtitle"></div>
      <div class="confetti" aria-hidden="true">
        <span>✦</span><span>✶</span><span>✹</span>
      </div>
    </div>
  </template>

  <div id="avatarPickerModal" class="avatar-picker-modal" aria-hidden="true">
    <div class="avatar-sheet" role="dialog" aria-modal="true" aria-labelledby="avatarPickerTitle">
      <button type="button" class="avatar-close-btn" id="avatarPickerClose" aria-label="סגור">✕</button>
      <h2 id="avatarPickerTitle">בחרו דמות</h2>
      <!-- שכבה לאפקט הניצוצות -->
      <div id="avatarSparkLayer"></div>
      <!-- הגריד נבנה דינמית ב-JS ל-16 פריטים -->
      <div class="avatar-grid" id="avatarPickerGrid"></div>
    </div>
  </div>

  <div id="celebrationRoot"></div>

  <!-- קוד הלוגיקה (app.js) -->
  <script type="module" src="app.js"></script>
</body>
</html>
